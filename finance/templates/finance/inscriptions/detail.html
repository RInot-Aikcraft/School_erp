{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}
{% block title %}Détails de l'Inscription #{{ inscription.id }}{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Détails de l'Inscription #{{ inscription.id }}</h5>
                        <a href="{% url 'finance:liste_inscriptions' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Informations sur l'inscription</h5>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Élève:</span>
                                            <strong>{{ inscription.eleve.get_full_name|default:inscription.eleve.username }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Année scolaire:</span>
                                            <strong>{{ inscription.annee_scolaire.name }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Classe demandée:</span>
                                            <strong>{{ inscription.classe_demandee.name }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Classe attribuée:</span>
                                            <strong>
                                                {% if inscription.classe_attribuee %}
                                                    {{ inscription.classe_attribuee.name }}
                                                {% else %}
                                                    <span class="text-muted">Non attribuée</span>
                                                {% endif %}
                                            </strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Date d'inscription:</span>
                                            <strong>{{ inscription.date_inscription|date:"d/m/Y H:i" }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Type d'inscription:</span>
                                            <strong>{{ inscription.get_type_inscription_display }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Statut:</span>
                                            <strong>
                                                {% if inscription.statut == 'EN_ATTENTE' %}
                                                    <span class="badge bg-warning">{{ inscription.get_statut_display }}</span>
                                                {% elif inscription.statut == 'ACCEPTÉE' %}
                                                    <span class="badge bg-info">{{ inscription.get_statut_display }}</span>
                                                {% elif inscription.statut == 'REFUSÉE' %}
                                                    <span class="badge bg-danger">{{ inscription.get_statut_display }}</span>
                                                {% elif inscription.statut == 'CONFIRMÉE' %}
                                                    <span class="badge bg-success">{{ inscription.get_statut_display }}</span>
                                                {% elif inscription.statut == 'ANNULÉE' %}
                                                    <span class="badge bg-secondary">{{ inscription.get_statut_display }}</span>
                                                {% endif %}
                                            </strong>
                                        </li>
                                        {% if inscription.date_confirmation %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Date de confirmation:</span>
                                            <strong>{{ inscription.date_confirmation|date:"d/m/Y H:i" }}</strong>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                            
                            {% if inscription.notes %}
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Notes</h5>
                                    <p>{{ inscription.notes }}</p>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Frais d'inscription</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Type de frais</th>
                                                    <th>Montant</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for type_frais in types_frais %}
                                                <tr>
                                                    <td>{{ type_frais.nom_frais }}</td>
                                                    <td>{{ type_frais.montant|format_ariary }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="2" class="text-center">Aucun frais d'inscription trouvé</td>
                                                </tr>
                                                {% endfor %}
                                                <tr class="table-active">
                                                    <th>Total</th>
                                                    <th>{{ frais_total_inscription|format_ariary }}</th>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Paiements des frais d'inscription</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Date</th>
                                                    <th>Montant</th>
                                                    <th>Mode</th>
                                                    <th>Statut</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for paiement in paiements_inscription %}
                                                <tr>
                                                    <td>{{ paiement.id }}</td>
                                                    <td>{{ paiement.date_paiement|date:"d/m/Y H:i" }}</td>
                                                    <td>{{ paiement.montant|format_ariary }}</td>
                                                    <td>{{ paiement.get_mode_paiement_display }}</td>
                                                    <td>
                                                        {% if paiement.statut == 'VALIDE' %}
                                                            Payé
                                                        {% elif paiement.statut == 'EN_ATTENTE' %}
                                                            En attente
                                                        {% elif paiement.statut == 'ANNULE' %}
                                                            Annulé
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <a href="{% url 'finance:modifier_paiement' paiement.pk %}" class="btn btn-sm btn-outline-info" title="Modifier">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            <a href="{% url 'finance:detail_paiement' paiement.pk %}" class="btn btn-sm btn-outline-primary" title="Détails">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="6" class="text-center">Aucun paiement trouvé</td>
                                                </tr>
                                                {% endfor %}
                                                <tr class="table-active">
                                                    <th>Total payé</th>
                                                    <th colspan="5">{{ montant_paye_inscription|format_ariary }}</th>
                                                </tr>
                                                <tr class="table-{% if solde_inscription > 0 %}danger{% else %}success{% endif %}">
                                                    <th>Solde</th>
                                                    <th colspan="5">{{ solde_inscription|format_ariary }}</th>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Calendrier de paiement des écolages</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Mois</th>
                                                    <th>Montant dû</th>
                                                    <th>Montant payé</th>
                                                    <th>Solde</th>
                                                    <th>Statut</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for mois in tous_les_mois %}
                                                <tr class="{% if mois.statut_temporel == 'à_venir' and not mois.est_paye %}table-info{% elif mois.est_paye %}table-success{% else %}table-danger{% endif %}">
                                                    <td>{{ mois.nom_mois }} {{ mois.annee }}</td>
                                                    <td>{{ mois.montant_du|format_ariary }}</td>
                                                    <td>{{ mois.montant_paye|format_ariary }}</td>
                                                    <td>{{ mois.solde|format_ariary }}</td>
                                                    <td>
                                                        {{ mois.statut_affiche }}
                                                    </td>
                                                    <td>
                                                        {% if mois.est_paye %}
                                                            <a href="{% url 'finance:ajouter_paiement' %}?eleve={{ inscription.eleve.id }}&mois={{ mois.mois }}" class="btn btn-sm btn-outline-secondary">
                                                                <i class="fas fa-receipt me-1"></i>Détails
                                                            </a>
                                                        {% elif mois.statut_temporel == 'à_venir' %}
                                                            <span class="text-muted">À venir</span>
                                                        {% else %}
                                                            <a href="{% url 'finance:ajouter_paiement' %}?eleve_id={{ inscription.eleve.id }}&mois={{ mois.mois }}&montant={{ mois.montant_du }}&inscription_id={{ inscription.id }}" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-money-bill-wave me-1"></i>Payer
                                                            </a>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                <tr class="table-active">
                                                    <th>Total</th>
                                                    <th>{{ mois_payes_count }} mois payés / {{ mois_impayes_count }} mois impayés / {{ mois_avenir_count }} mois à venir</th>
                                                    <th>{{ total_ecolage_du|format_ariary }}</th>
                                                    <th>{{ total_ecolage_paye|format_ariary }}</th>
                                                    <th>{{ solde_ecolage|format_ariary }}</th>
                                                    <th></th>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Autres paiements de l'élève</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Type de frais</th>
                                                    <th>Date</th>
                                                    <th>Montant</th>
                                                    <th>Mode</th>
                                                    <th>Statut</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for paiement in autres_paiements %}
                                                <tr>
                                                    <td>{{ paiement.id }}</td>
                                                    <td>{{ paiement.type_frais.nom_frais }}</td>
                                                    <td>{{ paiement.date_paiement|date:"d/m/Y H:i" }}</td>
                                                    <td>{{ paiement.montant|format_ariary }}</td>
                                                    <td>{{ paiement.get_mode_paiement_display }}</td>
                                                    <td>
                                                        {% if paiement.statut == 'VALIDE' %}
                                                            Payé
                                                        {% elif paiement.statut == 'EN_ATTENTE' %}
                                                            En attente
                                                        {% elif paiement.statut == 'ANNULE' %}
                                                            Annulé
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <a href="{% url 'finance:modifier_paiement' paiement.pk %}" class="btn btn-sm btn-outline-info" title="Modifier">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            <a href="{% url 'finance:detail_paiement' paiement.pk %}" class="btn btn-sm btn-outline-primary" title="Détails">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="7" class="text-center">Aucun autre paiement trouvé</td>
                                                </tr>
                                                {% endfor %}
                                                <tr class="table-active">
                                                    <th>Total payé</th>
                                                    <th colspan="6">{{ montant_paye_autres|format_ariary }}</th>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Actions</h5>
                                    <div class="d-grid gap-2">
                                        <a href="{% url 'finance:modifier_inscription' inscription.pk %}" class="btn btn-outline-info">
                                            <i class="fas fa-edit me-2"></i>Modifier
                                        </a>
                                        {% if inscription.statut == 'ACCEPTÉE' and inscription.est_complettement_paye %}
                                        <a href="{% url 'finance:confirmer_inscription' inscription.pk %}" class="btn btn-outline-success">
                                            <i class="fas fa-check me-2"></i>Confirmer
                                        </a>
                                        {% endif %}
                                        <a href="{% url 'finance:ajouter_paiement' %}?eleve_id={{ inscription.eleve.id }}&inscription_id={{ inscription.id }}&type_paiement=inscription" class="btn btn-outline-primary">
                                            <i class="fas fa-money-bill-wave me-2"></i>Ajouter un paiement d'inscription
                                        </a>
                                        <a href="{% url 'finance:ajouter_paiement' %}?eleve={{ inscription.eleve.id }}" class="btn btn-outline-primary">
                                            <i class="fas fa-money-bill-wave me-2"></i>Ajouter un autre paiement
                                        </a>
                                        {% if inscription.statut != 'ANNULÉE' %}
                                        <a href="{% url 'finance:supprimer_inscription' inscription.pk %}" class="btn btn-outline-danger">
                                            <i class="fas fa-trash me-2"></i>Supprimer
                                        </a>
                                        {% endif %}
                                        <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                                            <i class="fas fa-print me-2"></i>Imprimer
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Résumé financier</h5>
                                    <h6 class="card-subtitle mb-3 text-muted">Frais d'inscription</h6>
                                    <ul class="list-group list-group-flush mb-4">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Total des frais d'inscription:</span>
                                            <strong>{{ frais_total_inscription|format_ariary }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Montant payé:</span>
                                            <strong>{{ montant_paye_inscription|format_ariary }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Solde:</span>
                                            <strong>
                                                {% if solde_inscription > 0 %}
                                                    <span class="text-danger">{{ solde_inscription|format_ariary }}</span>
                                                {% else %}
                                                    <span class="text-success">{{ solde_inscription|format_ariary }}</span>
                                                {% endif %}
                                            </strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Statut du paiement:</span>
                                            <strong>
                                                {% if inscription.est_complettement_paye %}
                                                    Payé
                                                {% else %}
                                                    Impayé
                                                {% endif %}
                                            </strong>
                                        </li>
                                    </ul>
                                    
                                    <h6 class="card-subtitle mb-3 text-muted">Frais d'écolage</h6>
                                    <ul class="list-group list-group-flush mb-4">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Total des frais d'écolage:</span>
                                            <strong>{{ total_ecolage_du|format_ariary }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Montant payé:</span>
                                            <strong>{{ total_ecolage_paye|format_ariary }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Solde:</span>
                                            <strong>
                                                {% if solde_ecolage > 0 %}
                                                    <span class="text-danger">{{ solde_ecolage|format_ariary }}</span>
                                                {% else %}
                                                    <span class="text-success">{{ solde_ecolage|format_ariary }}</span>
                                                {% endif %}
                                            </strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Progression:</span>
                                            <strong>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar" role="progressbar" style="width: {% widthratio total_ecolage_paye total_ecolage_du 100 %}%" 
                                                        aria-valuenow="{{ total_ecolage_paye }}" aria-valuemin="0" aria-valuemax="{{ total_ecolage_du }}">
                                                        {{ mois_payes_count }} / {{ mois_payes_count|add:mois_impayes_count }} mois
                                                    </div>
                                                </div>
                                            </strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Mois à venir:</span>
                                            <strong>{{ mois_avenir_count }} mois</strong>
                                        </li>
                                    </ul>
                                    
                                    <h6 class="card-subtitle mb-3 text-muted">Autres frais</h6>
                                    <ul class="list-group list-group-flush mb-4">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Total des autres frais:</span>
                                            <strong>{{ total_autres_frais|format_ariary }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Montant payé:</span>
                                            <strong>{{ montant_paye_autres|format_ariary }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Solde:</span>
                                            <strong>
                                                {% if solde_autres > 0 %}
                                                    <span class="text-danger">{{ solde_autres|format_ariary }}</span>
                                                {% else %}
                                                    <span class="text-success">{{ solde_autres|format_ariary }}</span>
                                                {% endif %}
                                            </strong>
                                        </li>
                                    </ul>
                                    
                                    <hr class="my-4">
                                    
                                    <h6 class="card-subtitle mb-3 text-muted">Total général</h6>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Total des frais:</span>
                                            <strong>{{ frais_total_inscription|add:total_ecolage_du|add:total_autres_frais|format_ariary }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Total payé:</span>
                                            <strong>{{ montant_paye_inscription|add:total_ecolage_paye|add:montant_paye_autres|format_ariary }}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Total impayé:</span>
                                            <strong>
                                                {% with total_impaye=solde_inscription|add:solde_ecolage|add:solde_autres %}
                                                    {% if total_impaye > 0 %}
                                                        <span class="text-danger">{{ total_impaye|format_ariary }}</span>
                                                    {% else %}
                                                        <span class="text-success">{{ total_impaye|format_ariary }}</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Solde total:</span>
                                            <strong>
                                                {% with solde_total=solde_inscription|add:solde_ecolage|add:solde_autres %}
                                                    {% if solde_total > 0 %}
                                                        <span class="text-danger">{{ solde_total|format_ariary }}</span>
                                                    {% else %}
                                                        <span class="text-success">{{ solde_total|format_ariary }}</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </strong>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}